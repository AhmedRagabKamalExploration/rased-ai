# Malware Detection Module

## ğŸ”¬ The Research and "Why" Behind Client-Side Malware Detection

The core idea behind client-side malware detection is to identify malicious code that has been injected into a web page and is designed to steal user data, hijack sessions, or perform other fraudulent activities. This is a critical line of defense because traditional server-side security cannot detect these types of attacks.

## ğŸš¨ Malicious Indicators as a Signal

This module performs a detailed analysis of the web page's structure and loaded resources to find anomalies that are strong indicators of malicious activity.

## ğŸ•µï¸ Anti-Fraud and Bot Detection

- **Inline Script Analysis**: Malicious actors often inject small, obfuscated inline JavaScript snippets. This module hashes all inline `<script>` tags, both before and after the page has fully loaded, and sends these hashes to the backend for analysis. A change in the inline script hashes between these two points is a major red flag.

- **Form-Jacking**: This is a common attack where malicious code is injected into a payment form to steal credit card details. The module detects and fingerprints all input fields on the page, including their position and obfuscated IDs/labels. Inconsistencies in these properties can be a strong signal of a form-jacking attempt.

- **Cross-Domain Scripts**: Scripts loaded from a domain other than the primary site's host can be a source of attack. The module collects details about these scripts, such as their URL, length, and origin. A script loaded from a suspicious domain (e.g., one containing an IP address) is a critical signal.

- **IFrame Detection**: Malicious iframes are used for click-jacking and content injection. The module checks for the presence of iframes and can provide a signal if they are found on sensitive pages.

## ğŸ“Š Data Collection Strategy

The module uses an event-based approach to collect data at different stages of the page lifecycle.

- **Initial Load**: The module scans the `document.head` and `document.body` for script tags and other elements immediately upon page load.

- **Post-Load Analysis**: After the page has fully rendered, the module performs a second scan, specifically for scripts that may have been dynamically injected by other scripts.

- **Data Hashing**: To protect user privacy and minimize payload size, all sensitive data (like the content of script tags, input field IDs, and labels) is hashed using a cryptographic algorithm like SHA-256 before being transmitted.

- **Data Structuring**: The collected data is organized into a detailed payload that allows the backend to perform advanced analysis.

## ğŸ“Š Technical Implementation and Data Indicators

---

## ğŸ“¤ Output/Send Events to Backend

### ğŸš€ Event Transmission Format

The malware module sends events to the backend in the following structure:

```typescript
// Individual event sent to backend
interface MalwareBackendEvent {
  eventType: ""detection.malware" | "malware.error"";
  payload: MalwareData | MalwareError;
  timestamp: number; // Unix timestamp in milliseconds
}
```

### ğŸ“¦ Batch Event Structure

Events are sent as part of a batch to the backend API endpoint `POST /v1/event`:

```typescript
interface EventBatch {
  deviceId: string; // Unique device identifier
  batchId: string; // Unique batch identifier
  batchTimestamp: string; // ISO 8601 timestamp
  modules: {
    malware: MalwareBackendEvent[]; // Array of malware events
    // ... other module events
  };
}
```

### ğŸ¯ Expected Backend Properties

The backend expects and stores the following properties for malware events:

#### Database Schema (events table)
```sql
{
  "id": "unique-event-id",
  "transaction_id": "txn-xxx",
  "organization_id": "org-xxx", 
  "session_id": "ssn-xxx",
  "device_id": "device-xxx",
  "batch_id": "batch-xxx",
  "event_type": "detection.malware", // or other malware event types
  "payload": {
    /* malware specific data structure */
  },
  "received_at": "2024-01-15T12:00:00.000Z"
}
```

#### Malware Event Example
```json
{
  "eventType": "detection.malware",
  "payload": {
    /* Example payload data */
  },
  "timestamp": 1642248000000
}
```

### ğŸ”„ Event Processing Flow

1. **Collection**: Module collects malware data during initialization
2. **Analysis**: Advanced analysis performed on collected data
3. **Event Creation**: Creates event with proper structure and timestamp
4. **Batching**: Event added to current batch with other module events
5. **Transmission**: Batch sent to backend via `POST /v1/event`
6. **Storage**: Backend stores individual events in database
7. **Analysis**: Events can be queried and analyzed for fraud detection

### ğŸ“Š Backend Event Validation

The backend validates incoming malware events against these requirements:

- âœ… `eventType` must be valid malware event type
- âœ… `payload` must contain required fields based on event type
- âœ… `timestamp` must be valid Unix timestamp
- âœ… All required fields must be present and valid
- âœ… Data types must match expected schema


### ğŸ—ï¸ Event Structure

```typescript
interface MalwareEvent {
  eventId: string;
  eventType: "malware" | "malware.error";
  moduleName: "malware";
  timestamp: string;
  payload: MalwareData | MalwareError;
}
```

### ğŸ“‹ Data Structures

#### âœ… Successful Generation (`malware`)

```typescript
interface MalwareData {
  hostSite: string; // The hostname of the current page
  urls: {
    url: string;
    length: number;
    htmlSection: "HEAD" | "BODY";
    isSuspiciouslyLong: boolean;
    isCrossDomain: boolean;
    containsIPAddress: boolean;
    isExecutable: boolean;
    isMalicious: boolean; // This would be a backend classification
  }[];
  numberOfInputFields: number;
  inputFields: {
    id: string; // Hashed ID
    label: string; // Hashed Label
    top: number;
    right: number;
    bottom: number;
    left: number;
  }[];
  hasIFrame: boolean;
  inlineJavaScriptContent: {
    content: string; // Hashed script content
  }[];
  postLoadJavaScriptContent?: {
    content: string; // Hashed script content from a post-load scan
  }[];
  timestamp: number;
}
```

#### âŒ Error Response (`malware.error`)

```typescript
interface MalwareError {
  error: string;
  errorCode: "DOM_SCAN_FAILED" | "UNEXPECTED_ERROR";
  details: {
    message: string;
  };
}
```
