# Malware Detection Module

## üî¨ The Research and "Why" Behind Client-Side Malware Detection

The core idea behind client-side malware detection is to identify malicious code that has been injected into a web page and is designed to steal user data, hijack sessions, or perform other fraudulent activities. This is a critical line of defense because traditional server-side security cannot detect these types of attacks.

## üö® Malicious Indicators as a Signal

This module performs a detailed analysis of the web page's structure and loaded resources to find anomalies that are strong indicators of malicious activity.

## üïµÔ∏è Anti-Fraud and Bot Detection

- **Inline Script Analysis**: Malicious actors often inject small, obfuscated inline JavaScript snippets. This module hashes all inline `<script>` tags, both before and after the page has fully loaded, and sends these hashes to the backend for analysis. A change in the inline script hashes between these two points is a major red flag.

- **Form-Jacking**: This is a common attack where malicious code is injected into a payment form to steal credit card details. The module detects and fingerprints all input fields on the page, including their position and obfuscated IDs/labels. Inconsistencies in these properties can be a strong signal of a form-jacking attempt.

- **Cross-Domain Scripts**: Scripts loaded from a domain other than the primary site's host can be a source of attack. The module collects details about these scripts, such as their URL, length, and origin. A script loaded from a suspicious domain (e.g., one containing an IP address) is a critical signal.

- **IFrame Detection**: Malicious iframes are used for click-jacking and content injection. The module checks for the presence of iframes and can provide a signal if they are found on sensitive pages.

## üìä Data Collection Strategy

The module uses an event-based approach to collect data at different stages of the page lifecycle.

- **Initial Load**: The module scans the `document.head` and `document.body` for script tags and other elements immediately upon page load.

- **Post-Load Analysis**: After the page has fully rendered, the module performs a second scan, specifically for scripts that may have been dynamically injected by other scripts.

- **Data Hashing**: To protect user privacy and minimize payload size, all sensitive data (like the content of script tags, input field IDs, and labels) is hashed using a cryptographic algorithm like SHA-256 before being transmitted.

- **Data Structuring**: The collected data is organized into a detailed payload that allows the backend to perform advanced analysis.

## üìä Technical Implementation and Data Indicators

### üèóÔ∏è Event Structure

```typescript
interface MalwareEvent {
  eventId: string;
  eventType: "malware" | "malware.error";
  moduleName: "malware";
  timestamp: string;
  payload: MalwareData | MalwareError;
}
```

### üìã Data Structures

#### ‚úÖ Successful Generation (`malware`)

```typescript
interface MalwareData {
  hostSite: string; // The hostname of the current page
  urls: {
    url: string;
    length: number;
    htmlSection: "HEAD" | "BODY";
    isSuspiciouslyLong: boolean;
    isCrossDomain: boolean;
    containsIPAddress: boolean;
    isExecutable: boolean;
    isMalicious: boolean; // This would be a backend classification
  }[];
  numberOfInputFields: number;
  inputFields: {
    id: string; // Hashed ID
    label: string; // Hashed Label
    top: number;
    right: number;
    bottom: number;
    left: number;
  }[];
  hasIFrame: boolean;
  inlineJavaScriptContent: {
    content: string; // Hashed script content
  }[];
  postLoadJavaScriptContent?: {
    content: string; // Hashed script content from a post-load scan
  }[];
  timestamp: number;
}
```

#### ‚ùå Error Response (`malware.error`)

```typescript
interface MalwareError {
  error: string;
  errorCode: "DOM_SCAN_FAILED" | "UNEXPECTED_ERROR";
  details: {
    message: string;
  };
}
```
